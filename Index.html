<!-- Version 1.9.8 - 02/02/2026 - Click photo to enlarge in checklist -->
<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
      :root {
        --bg-color: #f4f6f8; --text-color: #333; --card-bg: white;
        --header-bg: #1565c0; --border-color: #ddd; --section-bg: #f9f9f9;
        --input-bg: white; --input-text: #333; --table-header-bg: #eee; --table-header-text: #333;
        --placeholder-color: #bbb;
      }
      body.dark-mode {
        --bg-color: #121212; --text-color: #e0e0e0; --card-bg: #1e1e1e;
        --header-bg: #0d47a1; --border-color: #333; --input-bg: #2c2c2c; --input-text: #e0e0e0;
        --table-header-bg: #333; --table-header-text: #e0e0e0; --section-bg: #252525; --zone-border: #42a5f5;
        --placeholder-color: #666;
      }
      body { font-family: 'Roboto', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; transition: background-color 0.3s; }
      
      .top-header { background-color: var(--header-bg); color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
      .header-actions { display:flex; gap:15px; align-items:center; }
      .header-btn { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.5); padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 0.9rem; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
      .header-btn:hover { background: rgba(255,255,255,0.25); border-color:white; }
      .header-select { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.5); padding: 6px 10px; border-radius: 4px; font-size: 0.85rem; }
      .header-select option { color: #333; }
      .admin-select { background: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); }
      .admin-select option { color: var(--text-color); }

      #global-loader { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 2000; justify-content: center; align-items: center; flex-direction: column; color:#1565c0; }
      .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #1565c0; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 15px; }
      .mini-spinner { border: 4px solid #e0e0e0; border-top: 4px solid #1565c0; border-radius: 50%; width: 22px; height: 22px; animation: spin 1s linear infinite; display: inline-block; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      #error-box { display: none; background: #ffebee; color: #c62828; border: 1px solid #c62828; padding: 20px; border-radius: 8px; margin: 20px; text-align: center; }

      .stats-bar { background-color: #263238; color: white; padding: 12px 20px; display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; font-size: 0.9rem; }
      .container { padding: 20px; }
      .cat-header { background-color: #546e7a; color: white; padding: 10px 15px; font-weight: bold; text-transform: uppercase; border-radius: 4px 4px 0 0; margin-top:20px; }
      .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; background-color: var(--card-bg); padding: 20px; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 4px 4px; }
      
      .card { border-radius: 12px; padding: 16px; cursor: pointer; color: white; min-height: 110px; display: flex; flex-direction: column; justify-content: space-between; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; font-size: 0.95rem; box-shadow: 0 2px 8px rgba(0,0,0,0.12); border: 1px solid rgba(255,255,255,0.1); }
      .card:hover { transform: translateY(-6px) scale(1.02); box-shadow: 0 12px 20px rgba(0,0,0,0.25); }
      .card-title { white-space: normal; word-break: break-word; line-height: 1.2; }
      .card-title .loc { font-size:0.8em; font-weight:400; opacity:0.9; }
      .card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: rgba(255,255,255,0.3); }
      .card.status-red { background: linear-gradient(135deg, #ef5350 0%, #e53935 50%, #d32f2f 100%); box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3); }
      .card.status-red:hover { box-shadow: 0 12px 25px rgba(244, 67, 54, 0.4); }
      .card.status-orange { background: linear-gradient(135deg, #ffb74d 0%, #ff9800 50%, #f57c00 100%); box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3); }
      .card.status-orange:hover { box-shadow: 0 12px 25px rgba(255, 152, 0, 0.4); }
      .card.status-green { background: linear-gradient(135deg, #66bb6a 0%, #4caf50 50%, #388e3c 100%); box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3); }
      .card.status-green:hover { box-shadow: 0 12px 25px rgba(76, 175, 80, 0.4); }
      .card.status-purple { background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); color: #4a148c; border: 2px solid #7b1fa2; text-decoration: line-through; box-shadow: 0 2px 8px rgba(123, 31, 162, 0.15); }
      .card.status-purple:hover { box-shadow: 0 8px 16px rgba(123, 31, 162, 0.25); }
      
      .qr-icon { position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.95); padding: 6px; border-radius: 6px; width: 32px; height: 32px; z-index: 100; cursor: pointer; opacity: 0.9; box-shadow: 0 2px 8px rgba(0,0,0,0.25); transition: all 0.2s; color:#333; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
      .qr-inline-btn { background: rgba(21,101,192,0.12); color: #1565c0; border: 1px solid rgba(21,101,192,0.35); padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; display: inline-flex; align-items: center; justify-content: center; line-height: 1; }
      .qr-inline-btn:hover { background: rgba(21,101,192,0.2); }

      .check-zone { background: var(--section-bg); border: 2px solid #1976d2; border-radius: 8px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 3px 8px rgba(0,0,0,0.15); }
      body.dark-mode .check-zone { border-color: #42a5f5; }
      .check-zone-header { background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color: white; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; }
      .sealed-checkbox { display: flex; align-items: center; gap: 6px; font-size: 13px; font-weight: normal; cursor: pointer; }
      .sealed-checkbox input[type="checkbox"] { cursor: pointer; width: 16px; height: 16px; }
      
      .zone-pos-container { display: flex; align-items: center; gap: 8px; }
      .zone-pos { font-size: 0.9rem; background: rgba(255,255,255,0.3); padding: 4px 10px; border-radius: 15px; font-weight: 500; }
      .cam-icon-btn { cursor: pointer; font-size: 1.2rem; filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.2)); transition: transform 0.2s; position: relative; display: inline-block; }
      .cam-icon-btn:hover { transform: scale(1.1); }

      .form-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color); font-size: 0.9rem; }
      .form-input-container { flex: 0 0 40%; display: flex; justify-content: flex-end; align-items: center; max-width: 250px; }
      .form-input-container input:not([type="checkbox"]) { width: 100%; max-width: 180px; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; text-align: right; background-color: var(--input-bg); color: var(--input-text); font-size: 0.9rem; }
      .form-input-container input::placeholder { color: var(--placeholder-color); font-style: italic; }

      /* SWITCH FIXE BLOQU√â */
      .switch { position: relative; display: inline-block; width: 50px !important; min-width: 50px !important; height: 26px !important; flex: 0 0 50px !important; margin: 0; }
      .switch input { opacity: 0; width: 0; height: 0; }
      .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 26px; }
      .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
      input:checked + .slider { background-color: #1565c0; }
      input:checked + .slider:before { transform: translateX(24px); }

      .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
      .modal { background: var(--card-bg); color: var(--text-color); border-radius: 8px; width: 95%; max-width: 650px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
      .modal-body { padding: 20px; overflow-y: auto; background: var(--card-bg); color: var(--text-color); }
      .modal-footer { padding: 15px; border-top: 1px solid var(--border-color); background: var(--section-bg); }

      #admin-view { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; }
      .admin-nav { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; flex-wrap:wrap; }
      .nav-btn { padding: 10px 20px; background: var(--section-bg); border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: var(--text-color); transition: 0.2s; }
      .nav-btn.active { background: #1565c0; color: white; }
      .admin-tab { display: none; } .admin-tab.active { display: block; }
      .inv-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
      .inv-table th { text-align: left; background: var(--table-header-bg); padding: 10px; border-bottom: 2px solid var(--border-color); color: var(--table-header-text); }
      .inv-table td { padding: 8px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
      .inv-table td input { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; font-size: 0.9rem; background-color: var(--input-bg); color: var(--input-text); }
      .inv-drag { cursor: grab; user-select: none; font-weight: bold; opacity: 0.6; }
      .admin-btn { background: #1565c0; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size:0.9rem; }
      .admin-btn.secondary { background: #78909c; } .admin-btn.success { background: #43a047; } .admin-btn.danger { background: #d32f2f; }
      .section-block { background: var(--section-bg); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; margin-bottom: 15px; color: var(--text-color); }
      .section-header { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
      .section-header input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
      .items-list { background: white; border-radius: 4px; }
      .item-row { display: flex; gap: 8px; align-items: center; padding: 8px; border-bottom: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color); }
      .item-row input, .item-row select { padding: 6px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 0.9rem; background: var(--input-bg); color: var(--input-text); }
      .item-row:last-child { border-bottom: none; }
      .cat-row { display: flex; gap: 10px; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color); }
      .sortable-ghost { opacity: 0.4; background: var(--section-bg); }
      .drag-handle { cursor: grab; user-select: none; }
      .item-drag-handle { cursor: grab; user-select: none; }
      .photo-thumb { width: 60px; height: 45px; object-fit: cover; border-radius: 4px; border: 1px solid var(--border-color); background: var(--section-bg); }
      .photo-admin-table { width:100%; border-collapse: collapse; margin-top: 10px; }
      .photo-admin-table th { text-align:left; background: var(--table-header-bg); padding: 8px; border-bottom: 2px solid var(--border-color); color: var(--table-header-text); font-size: 0.85rem; }
      .photo-admin-table td { padding: 6px; border-bottom: 1px solid var(--border-color); font-size: 0.85rem; vertical-align: middle; }
      .photo-history-table { width:100%; border-collapse: collapse; }
      .photo-history-table th { text-align:left; background: var(--table-header-bg); padding: 8px; border-bottom: 2px solid var(--border-color); color: var(--table-header-text); font-size: 0.85rem; }
      .photo-history-table td { padding: 6px; border-bottom: 1px solid var(--border-color); font-size: 0.85rem; vertical-align: middle; }
      .photo-badge { position: absolute; top: -8px; right: -8px; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.7rem; color: white; border: 2px solid var(--card-bg); }
      .photo-badge.has-photo { background-color: #4caf50; }
      .photo-badge.no-photo { background-color: #f44336; }

      /* MOBILE SPLASH */
      #splashChoice { position:fixed; top:0; left:0; width:100%; height:100%; z-index:99999; background:linear-gradient(135deg, #0d47a1 0%, #1a237e 100%); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:24px; }
      #splashChoice h2 { color:#fff; font-size:22px; text-align:center; margin:0; }
      #splashChoice p { color:rgba(255,255,255,.7); font-size:13px; margin:0; }
      .splashBtn { width:200px; padding:18px; border-radius:14px; border:2px solid rgba(255,255,255,.3); background:rgba(255,255,255,.08); color:#fff; font-size:17px; font-weight:700; cursor:pointer; transition:all .2s; text-align:center; }
      .splashBtn:hover { background:rgba(255,255,255,.15); border-color:rgba(255,255,255,.5); }
      #modeStrip { display:none; position:fixed; bottom:0; left:0; width:100%; z-index:99998; background:rgba(38,50,56,.95); border-top:1px solid rgba(255,255,255,.15); padding:6px 12px; text-align:center; font-size:11px; color:rgba(255,255,255,.7); backdrop-filter:blur(8px); }
      #modeStrip a { color:#42a5f5; cursor:pointer; text-decoration:underline; margin-left:6px; }

      /* MOBILE MODE */
      body.mobile-mode { padding-bottom:36px; }
      body.mobile-mode .top-header { flex-direction:column; gap:8px; padding:10px; text-align:center; }
      body.mobile-mode .top-header h1 { font-size:1.1rem; }
      body.mobile-mode .header-actions { flex-wrap:wrap; gap:6px; justify-content:center; }
      body.mobile-mode .header-btn { padding:6px 10px; font-size:0.8rem; }
      body.mobile-mode .stats-bar { flex-direction:column; gap:6px; padding:8px 12px; font-size:0.8rem; text-align:center; }
      body.mobile-mode .container { padding:10px; }
      body.mobile-mode .grid-container { grid-template-columns:1fr !important; gap:10px; padding:10px; }
      body.mobile-mode .card { min-height:80px; padding:12px; font-size:0.9rem; }
      body.mobile-mode .modal { width:100% !important; max-width:100% !important; max-height:100vh !important; height:100vh !important; border-radius:0 !important; }
      body.mobile-mode .modal-body { padding:12px; }
      body.mobile-mode .form-row { flex-direction:column; align-items:stretch; gap:4px; padding:10px 12px; }
      body.mobile-mode .form-input-container { flex:none; max-width:none; justify-content:stretch; }
      body.mobile-mode .form-input-container input:not([type="checkbox"]) { max-width:none; font-size:16px !important; padding:10px; }
      body.mobile-mode select, body.mobile-mode input[type="text"], body.mobile-mode input[type="number"], body.mobile-mode input[type="date"], body.mobile-mode textarea { font-size:16px !important; }
      body.mobile-mode .admin-nav { flex-wrap:wrap; gap:6px; }
      body.mobile-mode .nav-btn { padding:8px 10px; font-size:0.75rem; flex:1 1 auto; text-align:center; min-width:0; }
      body.mobile-mode .inv-table { font-size:0.75rem; display:block; overflow-x:auto; -webkit-overflow-scrolling:touch; }
      body.mobile-mode .cat-row { flex-wrap:wrap; }
      body.mobile-mode #admin-view { padding:10px; }
      body.mobile-mode .check-zone-header { flex-wrap:wrap; gap:6px; }

      /* CATEGORY COLLAPSE */
      .cat-header { display:flex; justify-content:space-between; align-items:center; }
      .cat-collapse-btn { background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); color:white; padding:2px 10px; border-radius:4px; cursor:pointer; font-size:0.85rem; transition:all .2s; line-height:1.4; }
      .cat-collapse-btn:hover { background:rgba(255,255,255,0.35); }
      .grid-container.collapsed { display:none !important; }

      /* VLI IMPACT BUTTON */
      .vli-impact-btn { display:inline-block; background:rgba(0,0,0,0.35); padding:4px 10px; border-radius:8px; font-size:0.8rem; cursor:pointer; backdrop-filter:blur(4px); transition:background .2s; margin-top:6px; }
      .vli-impact-btn:hover { background:rgba(0,0,0,0.55); }
    </style>
  </head>
  <body>
    <script>(function(){var m=localStorage.getItem('checklistMode');if(m==='mobile')document.body.classList.add('mobile-mode');})();</script>

    <div id="splashChoice">
      <div style="font-size:50px;">üìã</div>
      <h2>V√©rifications Mat√©riel</h2>
      <p>Comment souhaitez-vous consulter ?</p>
      <button class="splashBtn" onclick="chooseMobile()">üì± T√©l√©phone</button>
      <button class="splashBtn" onclick="chooseDesktop()">üíª Ordinateur</button>
    </div>
    <div id="modeStrip"></div>

    <input type="file" id="camInput" accept="image/*" capture="environment" style="display:none;" onchange="handlePhotoUpload(this)">
    <input type="file" id="impactInput" accept="image/*" capture="environment" style="display:none;" onchange="handleImpactUpload(this)">

    <div id="global-loader">
      <div class="spinner"></div>
      <div style="font-weight:bold;">Chargement...</div>
      <div id="error-box">
        <h3 style="margin-top:0;">‚ö†Ô∏è Probl√®me technique</h3>
        <p id="tech-error">Le serveur ne r√©pond pas.</p>
        <button class="header-btn" style="background:#d32f2f; margin: 0 auto;" onclick="forceReload()">üîÑ Recharger l'application</button>
      </div>
    </div>

    <div class="top-header">
      <div class="header-actions"><h1>V√©rifications</h1></div>
      <div class="header-actions">
        <select id="sort-mode" class="header-select" onchange="setSortMode(this.value)">
          <option value="num">Tri: Num√©ro</option>
          <option value="alpha">Tri: Alphab√©tique</option>
        </select>
        <button id="theme-toggle" class="header-btn" onclick="toggleDarkMode()">üåô Mode</button>
        <button onclick="toggleAdmin()" class="header-btn">‚öôÔ∏è Admin</button>
      </div>
    </div>

    <div id="dashboard-view">
      <div class="stats-bar">
        <div style="display:flex; gap:15px; flex-wrap:wrap;">
           <span style="color:#4caf50; font-weight:bold;">üü¢ OK</span>
           <span style="color:#ff9800; font-weight:bold;">üü† Limite</span>
           <span style="color:#f44336; font-weight:bold;">üî¥ Retard</span>
           <span style="color:#9c27b0; font-weight:bold; display:none;" id="leg-purple">üü£ P√©rim√©</span>
        </div>
      </div>
      <div id="app" class="container"></div>
    </div>

    <div id="admin-view">
      <div class="admin-nav">
        <button class="nav-btn" onclick="backToDashboard()" style="background:#ff9800; color:white;">üìä Dashboard</button>
        <button class="nav-btn active" onclick="showTab('tab-inv')">Inventaire</button>
        <button class="nav-btn" onclick="showTab('tab-vli-loc')">Localisation VLI</button>
        <button class="nav-btn" onclick="showTab('tab-conf')">Config</button>
        <button class="nav-btn" onclick="showTab('tab-content')">√âditeur</button>
        <button class="nav-btn" onclick="showTab('tab-history')">Historique</button>
        <button class="nav-btn" onclick="showTab('tab-stats')">Stats</button>
        <button class="nav-btn" onclick="showTab('tab-mailing')">Mailing</button>
        <button class="nav-btn" onclick="showTab('tab-photos')">Photos</button>
        <button class="nav-btn" onclick="showTab('tab-opts')">Options</button>
      </div>
      
      <div id="tab-inv" class="admin-tab active">
         <div class="admin-card">
           <div style="background:var(--section-bg); padding:10px; border-radius:4px; margin-bottom:15px; font-size:0.9rem; color:#1565c0;">
             üìÑ <b>Inventaire :</b> G√©rez vos sacs et VLI. Les mails doivent √™tre s√©par√©s par des <b>;</b> pour ajouter plusieurs destinataires.
           </div>
           <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
             <select id="new-bag-cat"></select>
             <input id="new-bag-name" placeholder="Nom du sac">
             <button class="admin-btn success" onclick="addBag()">+ Ajouter</button>
             <div style="margin-left:auto; display:flex; align-items:center; gap:8px;">
               <span style="font-size:0.85rem; color:var(--text-color);">Tri automatique:</span>
               <select id="sort-mode" class="header-select admin-select" onchange="setSortMode(this.value)">
                 <option value="num">Par num√©ro</option>
                 <option value="alpha">Par ordre alphab√©tique</option>
               </select>
             </div>
           </div>
          <table class="inv-table">
            <thead><tr><th>‚Üï</th><th>N¬∞</th><th>Cat√©gorie</th><th>Nom</th><th>Mails Orange</th><th>Mails Rouge</th><th>Action</th></tr></thead>
             <tbody id="inv-body"></tbody>
           </table>
         </div>
      </div>

      <div id="tab-vli-loc" class="admin-tab">
         <div class="admin-card">
           <div style="background:var(--section-bg); padding:10px; border-radius:4px; margin-bottom:15px; font-size:0.9rem; color:var(--text-color); border-left:4px solid #42a5f5;">
             üìç <b>Localisation VLI :</b> Renseignez l'emplacement de chaque VLI (affich√© sur les tuiles).
           </div>
           <div style="text-align:right; margin-bottom:10px;">
             <button class="admin-btn success" onclick="saveAllVliLocations()">üíæ Enregistrer</button>
           </div>
           <table class="inv-table">
             <thead><tr><th>VLI</th><th>Localisation</th></tr></thead>
             <tbody id="vli-loc-body"></tbody>
           </table>
         </div>
      </div>

      <div id="tab-conf" class="admin-tab">
         <div class="admin-card">
           <div style="background:var(--section-bg); padding:10px; border-radius:4px; margin-bottom:15px; font-size:0.9rem; color:var(--text-color); border-left:4px solid #ff9800;">
             ‚ö†Ô∏è <b>Configuration :</b> D√©finissez la fr√©quence de v√©rification (en jours) pour chaque cat√©gorie.
           </div>
           <div style="margin-bottom:15px; display:flex; gap:10px;"><input id="new-cat-name" placeholder="Cat√©gorie"><button class="admin-btn success" onclick="addCat()">Cr√©er</button></div>
           <div id="cat-conf"></div>
           <button class="admin-btn" onclick="saveCatConf()">Sauvegarder les jours</button>
         </div>
      </div>

      <div id="tab-content" class="admin-tab">
         <div class="admin-card">
           <select id="cat-selector" onchange="renderEditor()" style="width:100%; padding:10px; margin-bottom:15px;"></select>
           <div id="editor-container"></div>
           <div style="display:flex; gap:10px; margin-top:20px;">
             <button class="admin-btn secondary" style="flex:1;" onclick="addSection()">+ Section</button>
             <button class="admin-btn success" style="flex:1;" onclick="saveEditor()">üíæ Sauvegarder Checklist</button>
           </div>
         </div>
      </div>

      <div id="tab-history" class="admin-tab">
         <div class="admin-card">
           <table class="inv-table">
             <thead><tr><th>Date</th><th>Nom</th><th>Qui</th><th>Actions</th></tr></thead>
             <tbody id="hist-body"></tbody>
           </table>
         </div>
      </div>

      <div id="tab-stats" class="admin-tab">
         <div class="admin-card">
           <h3>üìä Statistiques & Analyses</h3>
           
           <!-- Filtres -->
           <div style="background:var(--section-bg); padding:15px; border-radius:8px; margin-bottom:20px; display:flex; gap:15px; flex-wrap:wrap; align-items:center; color:var(--text-color);">
             <label><b>P√©riode:</b></label>
             <select id="stats-period" onchange="renderStats()">
               <option value="all">Toutes donn√©es</option>
               <option value="month">Ce mois</option>
               <option value="3months">3 derniers mois</option>
               <option value="year">Cette ann√©e</option>
             </select>
           </div>
           
           <!-- Graphiques -->
           <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(350px, 1fr)); gap:20px; margin-bottom:30px;">
             <div style="background:var(--card-bg); padding:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); color:var(--text-color);">
               <h4 style="margin-top:0;">ü•ß √âtat Global du Parc</h4>
               <canvas id="pieChart" style="max-height:300px;"></canvas>
             </div>
             
             <div style="background:var(--card-bg); padding:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); color:var(--text-color);">
               <h4 style="margin-top:0;">üìä Contr√¥les par Mois <small style="font-weight:normal; color:var(--placeholder-color);">(nombre de v√©rifications)</small></h4>
               <canvas id="monthlyChart" style="max-height:300px;"></canvas>
             </div>
           </div>
           
           <!-- Stats textuelles -->
           <div id="stats-text-container"></div>
         </div>
      </div>

      <div id="tab-mailing" class="admin-tab">
         <div class="admin-card">
           <div style="background:var(--section-bg); padding:15px; border-radius:8px; margin-bottom:20px; color:var(--text-color);">
             <h4 style="color:#ff9800; margin:0 0 10px 0;">‚ö†Ô∏è Alerte Orange - Fin de Validit√©</h4>
             <small style="color:#ff9800; font-weight:bold;">Tags disponibles:</small>
             <div style="background:var(--card-bg); padding:10px; border-radius:4px; margin:8px 0; font-family:monospace; font-size:0.85rem; color:var(--text-color); border:1px solid var(--border-color);">
               {nom} = Nom du sac/VLI<br>
               {date} = Date limite de validit√©<br>
               {categorie} = Cat√©gorie<br>
               {echeance} = Prochaine validation requise
             </div>
             <label style="display:block; margin-top:10px;"><b>Sujet:</b></label>
             <input id="mailOrangeSub2" style="width:100%; margin-bottom:10px; padding:10px; border:1px solid #ff9800; border-radius:4px; background:var(--input-bg); color:var(--input-text);" placeholder="Ex: ‚ö†Ô∏è Revalidation requise pour {nom}">
             <label style="display:block; margin-top:10px;"><b>Message:</b></label>
             <textarea id="mailOrangeBody2" rows="6" style="width:100%; margin-bottom:10px; padding:10px; border:1px solid #ff9800; border-radius:4px; font-family:monospace; background:var(--input-bg); color:var(--input-text);" placeholder="Ex: Bonjour,&#10;&#10;Le sac/VLI {nom} arrive en fin de validit√© le {date}.&#10;&#10;Une revalidation est n√©cessaire d√®s que possible.&#10;&#10;Merci"></textarea>
             <button class="admin-btn secondary" onclick="setMailTemplate('orange')" style="padding:10px 20px; min-width:auto;">üìã Utiliser mod√®le de base</button>
           </div>
           
           <div style="background:var(--section-bg); padding:15px; border-radius:8px; margin-bottom:20px; color:var(--text-color);">
             <h4 style="color:#f44336; margin:0 0 10px 0;">üî¥ Alerte Rouge - Date D√©pass√©e</h4>
             <small style="color:#f44336; font-weight:bold;">Tags disponibles:</small>
             <div style="background:var(--card-bg); padding:10px; border-radius:4px; margin:8px 0; font-family:monospace; font-size:0.85rem; color:var(--text-color); border:1px solid var(--border-color);">
               {nom} = Nom du sac/VLI<br>
               {date} = Date d√©pass√©e<br>
               {categorie} = Cat√©gorie<br>
               {echeance} = Validation expir√©e depuis
             </div>
             <label style="display:block; margin-top:10px;"><b>Sujet:</b></label>
             <input id="mailRedSub2" style="width:100%; margin-bottom:10px; padding:10px; border:1px solid #f44336; border-radius:4px; background:var(--input-bg); color:var(--input-text);" placeholder="Ex: üî¥ URGENT - Validit√© d√©pass√©e pour {nom}">
             <label style="display:block; margin-top:10px;"><b>Message:</b></label>
             <textarea id="mailRedBody2" rows="6" style="width:100%; margin-bottom:10px; padding:10px; border:1px solid #f44336; border-radius:4px; font-family:monospace; background:var(--input-bg); color:var(--input-text);" placeholder="Ex: URGENT!&#10;&#10;La date de validit√© du sac/VLI {nom} est d√©pass√©e depuis le {date}.&#10;&#10;Une revalidation imm√©diate est obligatoire!&#10;&#10;Merci"></textarea>
             <button class="admin-btn secondary" onclick="setMailTemplate('red')" style="padding:10px 20px; min-width:auto;">üìã Utiliser mod√®le de base</button>
           </div>
           
           <button class="admin-btn success" onclick="saveMailConfDirect()" style="margin-top:20px; width:100%; padding:12px; font-size:1rem;">üíæ Enregistrer les Mod√®les</button>
           
           <hr style="margin:25px 0;">
           <div style="background:var(--section-bg); padding:15px; border-radius:8px; color:var(--text-color);">
             <h4 style="color:#1565c0; margin:0 0 10px 0;">üîî Rappel Automatique Quotidien</h4>
             <small style="color:#1565c0;">Les alertes seront envoy√©es chaque jour √† l'heure s√©lectionn√©e.</small>
             <div style="margin-top:10px; display:flex; align-items:center; gap:10px;">
               <input type="number" id="trigger-hour" value="8" style="width:70px; padding:10px; border:1px solid #1565c0; border-radius:4px;" min="0" max="23">
               <span style="font-weight:bold;">h 00</span>
               <button class="admin-btn" onclick="installTriggerUI()" style="flex:1;">üîî Activer</button>
             </div>
           </div>
         </div>
      </div>

      <div id="tab-photos" class="admin-tab">
         <div class="admin-card">
           <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
             <h3 style="margin:0;">üì∑ Gestion Photos</h3>
             <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
               <label style="font-size:0.85rem;"><input type="checkbox" id="photo-filter-has" onchange="applyPhotoFilters()"> Afficher uniquement si photo existante</label>
               <label style="font-size:0.85rem;"><input type="checkbox" id="photo-filter-none" onchange="applyPhotoFilters()"> Afficher uniquement si pas de photo</label>
               <button class="admin-btn secondary" onclick="openPhotoHistory()">üïò Historique</button>
             </div>
           </div>
           <div id="photo-admin-list" style="font-size:0.9rem; margin-top:10px;">Chargement des photos...</div>
         </div>
      </div>

      <div id="tab-opts" class="admin-tab">
         <div class="admin-card">
           <div style="margin-bottom:15px;"><label class="switch"><input type="checkbox" id="opt-exp"><span class="slider"></span></label> <b>P√©remption Objet</b></div>
           <div style="margin-bottom:15px;"><label class="switch"><input type="checkbox" id="opt-qr"><span class="slider"></span></label> <b>QR Code</b></div>
           <div style="margin-bottom:15px;"><label class="switch"><input type="checkbox" id="opt-verif"><span class="slider"></span></label> <b>Identification Obligatoire</b></div>
           <div style="margin-bottom:15px;"><label class="switch"><input type="checkbox" id="opt-photo"><span class="slider"></span></label> <b>Photos (Ic√¥ne üì∑)</b></div>
           <button class="admin-btn success" onclick="saveOptions()">Sauvegarder</button>
         </div>
      </div>
    </div>

    <div id="chkModal" class="modal-overlay">
      <div class="modal" style="max-height: 95vh; height: 95vh;">
        <div class="modal-header" style="padding:12px 15px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; background:var(--section-bg);">
          <div style="display:flex; align-items:center; gap:8px;">
            <h3 id="m-title" style="margin:0; color:#1565c0; font-size:1.1rem;">Checklist</h3>
            <button id="qr-btn" class="qr-inline-btn" onclick="showQRFromModal(event)" style="display:none;">üì±</button>
          </div>
          <span onclick="closeM('chkModal')" style="cursor:pointer; font-size:1.5rem; color:var(--text-color);">&times;</span>
        </div>
        <div class="modal-body" id="m-body" style="flex:1; overflow-y:auto;"></div>
        <div class="modal-footer" style="padding:12px; border-top:1px solid var(--border-color); background:var(--section-bg);">
           <div id="extra-fields" style="background:var(--section-bg); padding:10px; margin-bottom:10px; border-radius:4px; display:none; color:var(--text-color);">
              <b style="font-size:0.9rem;">‚ö†Ô∏è P√©remption Objet</b><br> 
              <div style="display:flex; gap:8px; margin-top:5px; flex-wrap:wrap;"><input id="next-item" placeholder="Nom" style="flex:1; min-width:120px; padding:6px; border:1px solid #ccc;"><input type="date" id="next-date" style="padding:6px; border:1px solid #ccc;"></div>
           </div>
           <div id="verif-field" style="margin-bottom:10px; display:none;">
              <b style="font-size:0.9rem;">üë§ V√©rificateur :</b> 
              <input id="verif-name" style="width:100%; margin-top:5px; padding:8px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box;">
           </div>
           <button class="admin-btn success" style="width:100%; padding:10px; font-size:0.95rem;" onclick="submitCheck()">Valider le contr√¥le</button>
        </div>
      </div>
    </div>

    <div id="photoModal" class="modal-overlay" onclick="closeM('photoModal')">
       <div class="modal" style="width:350px;" onclick="event.stopPropagation()">
          <div class="modal-body" style="text-align:center;">
           <div id="photoLoading" style="display:none; margin-bottom:10px;"><span class="mini-spinner"></span></div>
             <img id="locationPhoto" style="max-width:100%; border-radius:8px; display:none; cursor:pointer;" onclick="event.stopPropagation(); enlargePhotoFromCheckModal()">
             <div id="noPhotoMsg">Recherche de la photo...</div>
          </div>
          <div style="padding:15px; display:flex; justify-content:space-between; border-top:1px solid var(--border-color);">
             <button class="admin-btn secondary" onclick="closeM('photoModal')">Retour</button>
             <button class="admin-btn" onclick="modifyPhoto()">üì∑ Modifier</button>
           <button id="deletePhotoBtn" class="admin-btn danger" style="display:none;" onclick="deleteCurrentPhoto()">üóëÔ∏è Supprimer</button>
          </div>
       </div>
    </div>

    <div id="photoPreviewModal" class="modal-overlay" onclick="closeM('photoPreviewModal')">
       <div class="modal" style="max-width:700px;" onclick="event.stopPropagation()">
          <div class="modal-body" style="text-align:center;">
             <img id="photoPreviewImg" style="max-width:100%; border-radius:8px;">
          </div>
          <div class="modal-footer" style="text-align:right;">
             <button class="admin-btn secondary" onclick="closeM('photoPreviewModal')">Fermer</button>
          </div>
       </div>
    </div>

    <div id="photoHistoryModal" class="modal-overlay" onclick="closeM('photoHistoryModal')">
       <div class="modal" style="max-width:900px;" onclick="event.stopPropagation()">
          <div class="modal-body">
             <h3 style="margin-top:0;">üïò Historique Photos</h3>
             <div id="photo-history-body">Chargement...</div>
          </div>
          <div class="modal-footer" style="text-align:right;">
             <button class="admin-btn secondary" onclick="closeM('photoHistoryModal')">Fermer</button>
          </div>
       </div>
    </div>

    <div id="qrModal" class="modal-overlay" onclick="closeM('qrModal')">
       <div class="modal" style="width:320px; text-align:center;" onclick="event.stopPropagation()">
          <div class="modal-body">
            <h4 id="qrTitle"></h4><img id="qr-img" style="width:200px; height:200px; border:1px solid var(--border-color); padding:10px;">
            <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
               <button class="admin-btn success" onclick="downloadQR()">üì• DL</button><button class="admin-btn secondary" onclick="printQR()">üñ®Ô∏è Print</button>
            </div>
          </div>
       </div>
    </div>

    <div id="histModal" class="modal-overlay" onclick="closeM('histModal')">
       <div class="modal" onclick="event.stopPropagation()"><div class="modal-body" id="hist-detail"></div></div>
    </div>

    <div id="vliImpactModal" class="modal-overlay" onclick="closeM('vliImpactModal')">
      <div class="modal" style="max-width:800px;" onclick="event.stopPropagation()">
        <div style="padding:12px 15px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center; background:var(--section-bg);">
          <h3 id="vliImpactTitle" style="margin:0; color:#ff9800;">üîç Impact v√©hicule</h3>
          <span onclick="closeM('vliImpactModal')" style="cursor:pointer; font-size:1.5rem; color:var(--text-color);">&times;</span>
        </div>
        <div class="modal-body" id="vliImpactBody" style="max-height:70vh; overflow-y:auto;">Chargement...</div>
        <div style="padding:12px; border-top:1px solid var(--border-color); background:var(--section-bg); display:flex; gap:10px;">
          <button class="admin-btn" onclick="addVliImpactPhoto()" style="flex:1;">üì∑ Ajouter photo + commentaire</button>
          <button class="admin-btn secondary" onclick="closeM('vliImpactModal')">Fermer</button>
        </div>
      </div>
    </div>

    <script>
      let D = {}; let APP_URL = ""; let CURR = null; let CURR_PHOTO_CATEGORY = null; let CURR_PHOTO_BAG = null; let CURR_PHOTO_SECTION = null; let CURR_PHOTO_FILE_ID = null; let IS_ADM = false;
      let SORT_MODE = localStorage.getItem('sortMode') || 'num';
      let PHOTO_META_BY_BAG = {};
      let MODAL_OPEN_TIME = null; // Timestamp d'ouverture du modal de v√©rification
      const QR_BAG_PARAM = <?!= bagParam ? '"' + bagParam + '"' : 'null' ?>; // Param√®tre bag du QR code

      // Anti-chargement infini : timeout de 15s
      const loaderTimeout = setTimeout(() => {
        if(document.getElementById('global-loader').style.display !== 'none'){
          document.getElementById('error-box').style.display = 'block';
          document.getElementById('tech-error').innerText = "D√©lai d√©pass√©. V√©rifiez votre connexion ou les permissions du script.";
        }
      }, 15000);

      window.onload = function() { 
        google.script.run.withSuccessHandler(u => { APP_URL=u; loadData(); }).withFailureHandler(fail).getAppUrl(); 
      };

      function fail(e) { 
        document.getElementById('error-box').style.display = 'block'; 
        document.getElementById('tech-error').innerText = e.message;
      }

      function loadData() {
        google.script.run.withSuccessHandler(res => {
          console.log("getBootstrapData response:", res);
          if (res && res.success) {
            D = res.data;
            D.photoPresence = res.photoPresence || {};
            D.vliMileages = res.vliMileages || {};
            render();

            if(QR_BAG_PARAM) {
              const item = D.inventory.find(i => i.name === QR_BAG_PARAM);
              if(item) {
                if(item.state === 'HS') alert("Ce bag est marqu√© Hors Service (HS)");
                else setTimeout(() => openCheck(item), 300);
              } else alert("Bag introuvable: " + QR_BAG_PARAM);
            }

            clearTimeout(loaderTimeout);
            document.getElementById('global-loader').style.display = 'none';
          } else { fail({message: res ? res.error : "Pas de r√©ponse du serveur"}); }
        }).withFailureHandler(fail).getBootstrapData();
      }

      function render() {
        document.getElementById('leg-purple').style.display = D.options.enableExpiry ? 'inline' : 'none';
        document.getElementById('opt-exp').checked = D.options.enableExpiry;
        document.getElementById('opt-qr').checked = D.options.enableQR;
        document.getElementById('opt-verif').checked = D.options.enableVerifier;
        document.getElementById('opt-photo').checked = D.options.enablePhotos !== false; // Par d√©faut true
        const sortSel = document.getElementById('sort-mode');
        if (sortSel) sortSel.value = SORT_MODE;

        const app = document.getElementById('app'); app.innerHTML = "";
        D.categoriesOrder.forEach(cat => {
           if(!D.dashboard[cat]) return;
           const h = document.createElement('div'); h.className = 'cat-header';
           const hLabel = document.createElement('span'); hLabel.textContent = cat; h.appendChild(hLabel);
           const hBtn = document.createElement('button'); hBtn.className = 'cat-collapse-btn';
           const isCollapsed = localStorage.getItem('cat_collapsed_'+cat) === '1';
           hBtn.textContent = isCollapsed ? '‚ñ∏' : '‚ñæ';
           h.appendChild(hBtn);
           app.appendChild(h);
           const g = document.createElement('div'); g.className = 'grid-container' + (isCollapsed ? ' collapsed' : '');
           hBtn.onclick = () => { g.classList.toggle('collapsed'); const c = g.classList.contains('collapsed'); hBtn.textContent = c ? '‚ñ∏' : '‚ñæ'; localStorage.setItem('cat_collapsed_'+cat, c ? '1' : '0'); };
           const items = (D.dashboard[cat] || []).slice();
           if (SORT_MODE === 'alpha') {
             items.sort((a,b) => (a.name||'').localeCompare(b.name||'', 'fr'));
           } else {
             items.sort((a,b) => {
               const ao = parseInt(a.order,10); const bo = parseInt(b.order,10);
               if (!isNaN(ao) && !isNaN(bo) && ao !== bo) return ao - bo;
               if (!isNaN(ao) && isNaN(bo)) return -1;
               if (isNaN(ao) && !isNaN(bo)) return 1;
               return (a.name||'').localeCompare(b.name||'', 'fr');
             });
           }
           items.forEach(item => {
              if(item.state === 'HS') return;
              item.category = cat; 
              const div = document.createElement('div'); div.className = `card status-${item.status}`;
              
              // Nom en gras et plus gros avec meilleure typographie
              let cardContent = `<div class="card-title" style="font-size:1.25em; font-weight:600; margin-bottom:12px; letter-spacing:0.3px;">${item.name}${(cat === 'VLI' && item.location) ? ` <span class="loc">(${item.location})</span>` : ''}</div>`;
              
              // Dernier contr√¥le et prochain contr√¥le avec meilleure s√©paration
              cardContent += `<div class="card-info" style="font-size:0.9em; opacity:0.95; line-height:1.6;">`;
              cardContent += `<div style="margin-bottom:4px;">üìÖ Dernier: ${item.lastDate}</div>`;
              cardContent += `<div>‚è∞ Prochain: ${item.nextDate}</div>`;
              cardContent += `</div>`;
              
              // Prochaine p√©remption
              if(D.options.enableExpiry && item.nextItemName) {
                cardContent += `<div class="card-extra" style="font-size:0.85em; margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.2); opacity:0.9;">‚ö†Ô∏è P√©remption: ${item.nextItemName} le ${item.nextItemDate}</div>`;
              }
              
              // Dernier contr√¥leur
              if(D.options.enableVerifier && item.lastVerifier) {
                cardContent += `<div class="card-extra" style="border-top:${D.options.enableExpiry && item.nextItemName ? 'none' : '1px solid rgba(255,255,255,0.2)'}; opacity:0.85; font-size:0.85em; margin-top:${D.options.enableExpiry && item.nextItemName ? '4px' : '8px'}; padding-top:${D.options.enableExpiry && item.nextItemName ? '0' : '8px'};">üë§ ${item.lastVerifier}</div>`;
              }
              
              // VLI: afficher kilom√©trage
              if(cat === 'VLI' && D.vliMileages) {
                const mKey = (item.name||"").replace(/[^a-zA-Z0-9]/g,"_");
                const mData = D.vliMileages[mKey];
                if(mData) cardContent += `<div style="font-size:0.85em; margin-top:6px; padding-top:6px; border-top:1px solid rgba(255,255,255,0.2); opacity:0.9;">üöó ${mData.km} km ‚Äî ${mData.date}</div>`;
              }
              
              // VLI: bouton impact inline
              if(cat === 'VLI') {
                cardContent += `<div style="margin-top:6px;"><span class="vli-impact-btn" onclick="event.stopPropagation(); openVliImpact('${item.name.replace(/'/g,"\\'")}')">üîç Impact</span></div>`;
              }
              
              div.innerHTML = cardContent;
              
              div.onclick = () => openCheck(item); g.appendChild(div);
           });
           app.appendChild(g);
        });
        const sel = document.getElementById('new-bag-cat'); const sel2 = document.getElementById('cat-selector');
        sel.innerHTML = ""; sel2.innerHTML = "";
        D.categoriesOrder.forEach(c => { sel.innerHTML += `<option>${c}</option>`; sel2.innerHTML += `<option>${c}</option>`; });
        renderAdmin(); renderStats(); renderEditor();
      }

      function openCheck(item) {
        CURR = item; 
        MODAL_OPEN_TIME = Date.now(); // Enregistrer le timestamp d'ouverture
        document.getElementById('m-title').innerText = item.name;
        const qrBtn = document.getElementById('qr-btn');
        if (qrBtn) qrBtn.style.display = D.options.enableQR ? 'inline-flex' : 'none';
        document.getElementById('next-item').value = item.nextItemName || "";
        document.getElementById('verif-name').value = "";
        document.getElementById('extra-fields').style.display = D.options.enableExpiry ? 'block' : 'none';
        document.getElementById('verif-field').style.display = D.options.enableVerifier ? 'block' : 'none';
        const b = document.getElementById('m-body'); b.innerHTML = "";
        if(D.forms && D.forms[item.category]) {
           D.forms[item.category].forEach((sec, secIdx) => {
              let p = sec.position ? `<span class="zone-pos">${sec.position}</span>` : "";
              const photoKey = makePhotoKey(item.category, item.name, sec.section);
              const hasPhoto = checkPhotoPresence(photoKey);
              const badgeClass = hasPhoto ? 'has-photo' : 'no-photo';
              const badgeText = hasPhoto ? '1' : '0';
              let photoIcon = (D.options.enablePhotos !== false) ? 
                `<span class="cam-icon-btn" onclick="checkPhoto('${item.category}', '${item.name}', '${sec.section}')" data-photo-key="${photoKey}">üì∑<span class="photo-badge ${badgeClass}">${badgeText}</span></span>` : '';
              let sealedCheckbox = `<label class="sealed-checkbox"><input type="checkbox" onchange="toggleSealed(${secIdx})"> Scell√©</label>`;
              let h = `<div class="check-zone"><div class="check-zone-header"><span>${sec.section}</span><div class="zone-pos-container">${sealedCheckbox}${photoIcon}${p}</div></div><div class="check-zone-content" data-section="${secIdx}">`;
              sec.items.forEach(it => {
                 let f = ""; let d = it.def || '';
                 if(it.type == 'case') f = `<div class="form-input-container"><label class="switch"><input type="checkbox" data-id="${it.name}" data-def="${d}"><span class="slider"></span></label></div>`;
                 else if (it.type == 'date') f = `<div class="form-input-container"><input type="date" data-id="${it.name}" data-def="${d}" value="${d}"></div>`;
                 else if (it.type == 'nombre') f = `<div class="form-input-container"><input type="number" data-id="${it.name}" data-def="${d}" placeholder="${d}"></div>`;
                 else f = `<div class="form-input-container"><input type="text" data-id="${it.name}" data-def="${d}" placeholder="${d}"></div>`;
                 h += `<div class="form-row"><label>${it.name}</label>${f}</div>`;
              });
              b.innerHTML += h + `</div></div>`;
           });
        }
        // VLI: champs kilom√©trage en haut du formulaire
        if(item.category === 'VLI') {
          const mKey = (item.name||"").replace(/[^a-zA-Z0-9]/g,"_");
          const mData = D.vliMileages ? D.vliMileages[mKey] : null;
          const today = new Date().toISOString().split('T')[0];
          b.innerHTML = `<div class="check-zone" style="border-color:#ff9800;">
            <div class="check-zone-header" style="background:linear-gradient(135deg,#ff9800,#f57c00);">
              <span>üöó Kilom√©trage v√©hicule</span>
            </div>
            <div style="padding:10px;">
              <div class="form-row"><label>Kilom√©trage actuel</label><div class="form-input-container"><input type="number" id="vliKmInput" placeholder="${mData ? mData.km : 'km'}" style="font-size:16px;"></div></div>
              <div class="form-row"><label>Date du relev√©</label><div class="form-input-container"><input type="date" id="vliDateInput" value="${today}"></div></div>
            </div>
          </div>` + b.innerHTML;
        }
        document.getElementById('chkModal').style.display = 'flex';
      }

      function showQRFromModal(e) {
        if (e) e.stopPropagation();
        if (!D.options.enableQR || !CURR) return;
        showQR(CURR.name);
      }

      function toggleSealed(sectionIdx) {
        const section = document.querySelector(`.check-zone-content[data-section="${sectionIdx}"]`);
        const checkbox = event.target;
        if (checkbox.checked) {
          // Auto-remplir tous les champs avec leurs valeurs par d√©faut
          section.querySelectorAll('input[type="checkbox"][data-def]').forEach(input => {
            const def = input.getAttribute('data-def');
            input.checked = (def === 'true' || def === 'Oui' || def === true);
          });
          section.querySelectorAll('input[type="date"][data-def]').forEach(input => {
            input.value = input.getAttribute('data-def') || '';
          });
          section.querySelectorAll('input[type="number"][data-def]').forEach(input => {
            input.value = input.getAttribute('data-def') || '';
          });
          section.querySelectorAll('input[type="text"][data-def]').forEach(input => {
            input.value = input.getAttribute('data-def') || '';
          });
        } else {
          // R√©initialiser les champs
          section.querySelectorAll('input[type="checkbox"]').forEach(input => input.checked = false);
          section.querySelectorAll('input[type="date"], input[type="number"], input[type="text"]').forEach(input => input.value = '');
        }
      }

      function checkPhoto(category, bagName, section) {
         CURR_PHOTO_CATEGORY = category;
         CURR_PHOTO_BAG = bagName;
         CURR_PHOTO_SECTION = section;
         CURR_PHOTO_FILE_ID = null;
         const img = document.getElementById('locationPhoto');
         const msg = document.getElementById('noPhotoMsg');
         const loader = document.getElementById('photoLoading');
         const delBtn = document.getElementById('deletePhotoBtn');
         img.style.display = 'none';
         msg.style.display = 'block';
         msg.innerText = "Recherche de la photo...";
         loader.style.display = 'block';
         delBtn.style.display = 'none';
         document.getElementById('photoModal').style.display = 'flex';
         google.script.run.withSuccessHandler(res => {
            loader.style.display = 'none';
            if(res && res.hasPhoto && res.base64) {
              CURR_PHOTO_FILE_ID = res.fileId || null;
              img.src = res.base64;
              img.style.display = 'block';
              msg.style.display = 'none';
              if (CURR_PHOTO_FILE_ID) delBtn.style.display = 'inline-block';
            }
            else { 
              msg.innerText = "Aucune photo pour cet item.";
              img.style.display = 'none';
              delBtn.style.display = 'none';
            }
         }).getBagLatestPhotoMeta(category, bagName, section);
      }
      function modifyPhoto() {
         if (CURR_PHOTO_FILE_ID) {
           if (!confirm("Voulez-vous remplacer cette photo ?")) return;
         }
         triggerCam();
      }
      function triggerCam() { document.getElementById('camInput').click(); }
      function deleteCurrentPhoto() {
         if(!CURR_PHOTO_FILE_ID) return;
         if(!confirm("Supprimer la photo actuelle ?")) return;
         const loader = document.getElementById('photoLoading');
         const img = document.getElementById('locationPhoto');
         const msg = document.getElementById('noPhotoMsg');
         const delBtn = document.getElementById('deletePhotoBtn');
         loader.style.display = 'block';
         google.script.run.withSuccessHandler(res => {
            loader.style.display = 'none';
            if(res && res.success) {
              CURR_PHOTO_FILE_ID = null;
              img.style.display = 'none';
              msg.style.display = 'block';
              msg.innerText = "Aucune photo pour cet item.";
              delBtn.style.display = 'none';
              
              // Mettre √† jour le badge en temps r√©el
              const photoKey = makePhotoKey(CURR_PHOTO_CATEGORY, CURR_PHOTO_BAG, CURR_PHOTO_SECTION);
              setPhotoPresence(photoKey, false);
              updatePhotoBadgesInDOM();
            } else {
              alert("Erreur suppression: " + (res ? res.error : "Pas de r√©ponse"));
            }
         }).deletePhotoFile(CURR_PHOTO_FILE_ID);
      }
      
      function makePhotoKey(category, bagName, section) {
        return (category || "") + "||" + (bagName || "") + "||" + (section || "");
      }
      
      function checkPhotoPresence(photoKey) {
        if (!D.photoPresence) {
          D.photoPresence = {};
        }
        const sanitized = photoKey.replace(/[^a-zA-Z0-9]/g, "_");
        return !!D.photoPresence[sanitized];
      }
      
      function setPhotoPresence(photoKey, hasPhoto) {
        if (!D.photoPresence) D.photoPresence = {};
        const sanitized = photoKey.replace(/[^a-zA-Z0-9]/g, "_");
        D.photoPresence[sanitized] = hasPhoto;
      }
      
      function updatePhotoBadgesInDOM() {
        document.querySelectorAll('.cam-icon-btn').forEach(btn => {
          const photoKey = btn.dataset.photoKey;
          if (!photoKey) return;
          const hasPhoto = checkPhotoPresence(photoKey);
          const badge = btn.querySelector('.photo-badge');
          if (badge) {
            badge.textContent = hasPhoto ? '1' : '0';
            badge.className = 'photo-badge ' + (hasPhoto ? 'has-photo' : 'no-photo');
          }
        });
      }
      
      function handlePhotoUpload(input) {
         if (input.files && input.files[0]) {
            const r = new FileReader(); r.onload = e => {
               const img = new Image(); img.src = e.target.result;
               img.onload = () => {
                  const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                  const MAX = 800; let w = img.width; let h = img.height;
                  if (w > MAX) { h *= MAX/w; w = MAX; }
                  canvas.width = w; canvas.height = h; ctx.drawImage(img, 0, 0, w, h);
                  
                  // Afficher un loader
                  document.getElementById('noPhotoMsg').innerText = "Envoi en cours...";
                  document.getElementById('noPhotoMsg').style.display = 'block';
                  document.getElementById('locationPhoto').style.display = 'none';
                  document.getElementById('photoLoading').style.display = 'block';
                  
                  google.script.run
                    .withSuccessHandler((result) => { 
                      document.getElementById('photoLoading').style.display = 'none';
                      if(result && result.success) {
                        console.log("Photo ID: " + result.fileId);
                        
                        // Mettre √† jour le badge en temps r√©el
                        const photoKey = makePhotoKey(CURR_PHOTO_CATEGORY, CURR_PHOTO_BAG, CURR_PHOTO_SECTION);
                        setPhotoPresence(photoKey, true);
                        updatePhotoBadgesInDOM();
                        
                        setTimeout(() => checkPhoto(CURR_PHOTO_CATEGORY, CURR_PHOTO_BAG, CURR_PHOTO_SECTION), 300);
                      } else {
                        alert("Erreur sauvegarde: " + (result ? result.error : "Pas de r√©ponse"));
                      }
                    })
                    .withFailureHandler((err) => {
                      document.getElementById('photoLoading').style.display = 'none';
                      alert("Erreur: " + err.message);
                      console.error(err);
                    })
                    .saveBagPhoto(CURR_PHOTO_CATEGORY, CURR_PHOTO_BAG, CURR_PHOTO_SECTION, canvas.toDataURL('image/jpeg', 0.7));
               }
            }; r.readAsDataURL(input.files[0]);
         }
         // R√©initialiser l'input pour pouvoir rechoisir le m√™me fichier
         input.value = '';
      }

      function submitCheck() {
         const verif = document.getElementById('verif-name').value;
         const nItem = document.getElementById('next-item').value; const nDate = document.getElementById('next-date').value;
         if(D.options.enableVerifier && !verif) return alert("V√©rificateur obligatoire.");
         let data = {};
         document.querySelectorAll('#m-body input').forEach(i => {
            if(i.dataset.id) data[i.dataset.id] = (i.type == 'checkbox') ? (i.checked ? "Oui" : "Non") : (i.value || i.placeholder);
         });
         // Calculer le temps de v√©rification en minutes et secondes
         let verificationTime = "";
         if(MODAL_OPEN_TIME) {
           const totalSeconds = Math.round((Date.now() - MODAL_OPEN_TIME) / 1000);
           const minutes = Math.floor(totalSeconds / 60);
           const seconds = totalSeconds % 60;
           verificationTime = `${minutes}min${seconds}s`;
         }
         // VLI: sauvegarder kilom√©trage
         if(CURR.category === 'VLI') {
           const km = document.getElementById('vliKmInput') ? document.getElementById('vliKmInput').value : '';
           const kmDate = document.getElementById('vliDateInput') ? document.getElementById('vliDateInput').value : '';
           if(km) google.script.run.saveVliMileage(CURR.name, km, kmDate);
         }
         document.getElementById('chkModal').style.display = 'none'; document.getElementById('global-loader').style.display = 'flex';
         google.script.run.withSuccessHandler(loadData).saveCheck(CURR.name, data, nItem, nDate, verif, verificationTime);
      }

      function renderAdmin() {
         if(D.mailConfig) {
             document.getElementById('mailOrangeSub2').value = D.mailConfig.orangeSub || "‚ö†Ô∏è Revalidation requise pour {nom}";
             document.getElementById('mailOrangeBody2').value = D.mailConfig.orangeBody || "Bonjour,\n\nLe sac/VLI {nom} ({categorie}) arrive en fin de validit√© le {date}.\n\nUne revalidation est n√©cessaire d√®s que possible pour maintenir la conformit√©.\n\nMerci de proc√©der au contr√¥le rapidement.";
             document.getElementById('mailRedSub2').value = D.mailConfig.redSub || "üî¥ URGENT - Validit√© d√©pass√©e pour {nom}";
             document.getElementById('mailRedBody2').value = D.mailConfig.redBody || "URGENT!\n\nLe sac/VLI {nom} ({categorie}) a d√©pass√© sa date de validit√© depuis le {date}.\n\nCe mat√©riel N'EST PLUS CONFORME et ne peut pas √™tre utilis√©.\n\nUne revalidation imm√©diate et obligatoire est requise!\n\nMerci d'agir sans d√©lai.";
         }
         const hb = document.getElementById('hist-body'); 
         hb.innerHTML="";
         D.history.forEach((h, idx) => { 
           const dateDisplay = h.dateStr || (h.date ? new Date(h.date).toLocaleString('fr-FR') : '?');
           hb.innerHTML += `<tr><td>${dateDisplay}</td><td><b>${h.name}</b></td><td>${h.verifier || 'N/A'}</td><td><button class="admin-btn" onclick="openHistoryDetail(${idx})">üëÅÔ∏è</button> <button class="admin-btn secondary" onclick="generatePdfForItem('${h.name.replace(/'/g, "\\'")}')">üìÑ PDF</button> <button class="admin-btn danger" style="padding:5px 8px;" onclick="deleteHistoryConfirm(${idx}, '${h.name.replace(/'/g, "\\'")}', '${dateDisplay}')">üóëÔ∏è</button></td></tr>`; 
         });
        const ib = document.getElementById('inv-body'); ib.innerHTML="";
        const invList = (D.inventory || []).slice().sort((a,b) => {
          if ((a.category||'') !== (b.category||'')) return (a.category||'').localeCompare(b.category||'', 'fr');
          if (SORT_MODE === 'alpha') {
            return (a.name||'').localeCompare(b.name||'', 'fr');
          }
          const ao = parseInt(a.order,10); const bo = parseInt(b.order,10);
          if (!isNaN(ao) && !isNaN(bo) && ao !== bo) return ao - bo;
          return (a.name||'').localeCompare(b.name||'', 'fr');
        });
        invList.forEach(i => {
          let s = i.state === 'HS' ? `<button class="admin-btn success" onclick="setBagStatus('${i.name.replace(/'/g, "\\'")}',' Actif')">Activer</button> <button class="admin-btn danger" onclick="if(confirm('Supprimer ${i.name} ?')) delBag('${i.name.replace(/'/g, "\\'")}')">üóëÔ∏è</button>` : `<button class="admin-btn secondary" onclick="setBagStatus('${i.name.replace(/'/g, "\\'")}',' HS')">HS</button> <button class="admin-btn danger" onclick="if(confirm('Supprimer ${i.name} ?')) delBag('${i.name.replace(/'/g, "\\'")}')">üóëÔ∏è</button>`;
          ib.innerHTML += `<tr data-bag="${i.name}" data-cat="${i.category}"><td class="inv-drag">‚Üï</td><td class="order-cell">${i.order || ''}</td><td>${i.category}</td><td><b>${i.name}</b> <button class="admin-btn" style="padding:2px 6px; font-size:0.8rem; margin-left:5px;" onclick="renameBag('${i.name.replace(/'/g, "\\'")}')">‚úèÔ∏è</button></td><td><input value="${i.mailOrange||''}" placeholder="mail1@test.com; mail2@test.com" data-bag="${i.name}" data-type="orange" onchange="updateMail(this)" style="width:100%; padding:8px; border:1px solid var(--border-color); border-radius:4px; background:var(--input-bg); color:var(--input-text);"></td><td><input value="${i.mailRed||''}" placeholder="mail1@test.com; mail2@test.com" data-bag="${i.name}" data-type="red" onchange="updateMail(this)" style="width:100%; padding:8px; border:1px solid var(--border-color); border-radius:4px; background:var(--input-bg); color:var(--input-text);"></td><td>${s}</td></tr>`;
        });
        const vliBody = document.getElementById('vli-loc-body');
        if (vliBody) {
          vliBody.innerHTML = "";
          D.inventory.filter(i => i.category === 'VLI').forEach(i => {
            vliBody.innerHTML += `<tr><td><b>${i.name}</b></td><td><input value="${i.location || ''}" data-bag="${i.name}" placeholder="Ex: CIS Perpignan" style="width:100%; padding:8px; border:1px solid var(--border-color); border-radius:4px; background:var(--input-bg); color:var(--input-text);"></td></tr>`;
          });
        }
        const cl = document.getElementById('cat-conf'); cl.innerHTML="";
        D.categoriesOrder.forEach(c => { cl.innerHTML += `<div class="cat-row"><span class="drag-handle">‚ò∞</span> <input class="cat-name-input" value="${c}" readonly style="flex:1;"> <button class="admin-btn" style="padding:2px 6px; font-size:0.8rem; margin-left:5px;" onclick="renameCategory('${c.replace(/'/g, "\\'")}')">‚úèÔ∏è</button> <input class="cat-freq-input" value="${D.frequencies[c]||30}" size="3"> <span>Jours</span> <button class="admin-btn danger" style="padding:5px 10px;" onclick="deleteCategoryConfirm('${c.replace(/'/g, "\\'")}')">üóëÔ∏è</button></div>`; });

        initCategorySortable();
        initInventorySortable();

        renderPhotoAdminList();
      }

      function renderPhotoAdminList() {
        const container = document.getElementById('photo-admin-list');
        if (!container) return;
        container.innerHTML = `<div id="photo-admin-body"></div>`;
        const body = document.getElementById('photo-admin-body');
        if (!body) return;
        body.innerHTML = "";
        PHOTO_META_BY_BAG = {};
        
        let rowIndex = 0;
        D.inventory.forEach((item) => {
          const category = item.category;
          const bagName = item.name;
          
          // Header pour chaque bag
          body.innerHTML += `
            <div style="background: #f5f5f5; padding: 10px; margin-top: 15px; border-left: 4px solid #2196f3; font-weight: bold;">
              ${category} / ${bagName}
            </div>`;
          
          // Pour chaque item, parcourir ses sections
          if (D.forms && D.forms[category]) {
            D.forms[category].forEach((sec) => {
              const section = sec.section;
              const photoKey = makePhotoKey(category, bagName, section);
              const thumbId = `photo-thumb-${rowIndex}`;
              const statusId = `photo-status-${rowIndex}`;
              const addBtnId = `photo-add-${rowIndex}`;
              const delBtnId = `photo-del-${rowIndex}`;
              const rowId = `photo-row-${rowIndex}`;
              
              body.innerHTML += `
                <div id="${rowId}" data-has-photo="" style="display: flex; align-items: center; padding: 8px 15px; border-bottom: 1px solid #eee; margin-left: 20px;">
                  <div style="flex: 0 0 40px; color: #666;">‚ãÆ‚ãÆ</div>
                  <div style="flex: 1; font-weight: 500;">${section}</div>
                  <div style="flex: 0 0 120px; text-align: center;">
                    <div id="${statusId}"><span class="mini-spinner"></span></div>
                    <img id="${thumbId}" class="photo-thumb" style="display:none; cursor:pointer; max-width: 80px; max-height: 60px;" onclick="previewPhotoByKey('${photoKey.replace(/'/g, "\\'")}')"/>
                  </div>
                  <div style="flex: 0 0 280px; text-align: right;">
                    <button id="${addBtnId}" class="admin-btn" style="padding:6px 10px; margin-right: 5px;" onclick="openPhotoForSection('${category.replace(/'/g, "\\'")}', '${bagName.replace(/'/g, "\\'")}', '${section.replace(/'/g, "\\'")}')">üì∑ Ajouter</button>
                    <button id="${delBtnId}" class="admin-btn danger" style="padding:6px 10px; display:none;" onclick="deletePhotoForSection('${photoKey.replace(/'/g, "\\'")}')">üóëÔ∏è</button>
                  </div>
                </div>`;

              google.script.run.withSuccessHandler(res => {
                const statusEl = document.getElementById(statusId);
                const thumbEl = document.getElementById(thumbId);
                const delBtn = document.getElementById(delBtnId);
                const rowEl = document.getElementById(rowId);
                if (statusEl) statusEl.innerHTML = '';
                if (res && res.hasPhoto && res.base64) {
                  PHOTO_META_BY_BAG[photoKey] = res;
                  if (rowEl) rowEl.dataset.hasPhoto = "1";
                  if (thumbEl) {
                    thumbEl.src = res.base64;
                    thumbEl.style.display = 'inline-block';
                  }
                  if (delBtn && res.fileId) delBtn.style.display = 'inline-block';
                } else {
                  PHOTO_META_BY_BAG[photoKey] = null;
                  if (rowEl) rowEl.dataset.hasPhoto = "0";
                  if (statusEl) statusEl.innerText = 'Aucune';
                  if (thumbEl) thumbEl.style.display = 'none';
                  if (delBtn) delBtn.style.display = 'none';
                }
                applyPhotoFilters();
              }).getBagLatestPhotoMeta(category, bagName, section);
              
              rowIndex++;
            });
          }
        });
      }

      function applyPhotoFilters() {
        const onlyHas = document.getElementById('photo-filter-has')?.checked;
        const onlyNone = document.getElementById('photo-filter-none')?.checked;
        const rows = document.querySelectorAll('#photo-admin-body [data-has-photo]');
        rows.forEach(r => {
          const has = r.dataset.hasPhoto === '1';
          let show = true;
          if (onlyHas && !onlyNone) show = has;
          if (!onlyHas && onlyNone) show = !has;
          if (onlyHas && onlyNone) show = true;
          r.style.display = show ? 'flex' : 'none';
        });
      }

      function previewPhotoByKey(photoKey) {
        const meta = PHOTO_META_BY_BAG[photoKey];
        if (!meta || !meta.base64) return;
        showPhotoPreview(meta.base64);
      }

      function openPhotoForSection(category, bagName, section) {
        CURR_PHOTO_CATEGORY = category;
        CURR_PHOTO_BAG = bagName;
        CURR_PHOTO_SECTION = section;
        triggerCam();
      }

      function deletePhotoForSection(photoKey) {
        const meta = PHOTO_META_BY_BAG[photoKey];
        if (!meta || !meta.fileId) return;
        if (!confirm(`Supprimer cette photo ?`)) return;
        google.script.run.withSuccessHandler(res => {
          if (res && res.success) {
            setPhotoPresence(photoKey, false);
            updatePhotoBadgesInDOM();
            renderPhotoAdminList();
          } else {
            alert("Erreur suppression: " + (res ? res.error : "Pas de r√©ponse"));
          }
        }).deletePhotoFile(meta.fileId);
      }

      function showPhotoPreview(base64) {
        const img = document.getElementById('photoPreviewImg');
        img.src = base64;
        document.getElementById('photoPreviewModal').style.display = 'flex';
      }

      function openPhotoHistory() {
        const body = document.getElementById('photo-history-body');
        body.innerHTML = 'Chargement...';
        document.getElementById('photoHistoryModal').style.display = 'flex';
        google.script.run.withSuccessHandler(rows => {
          if (!rows || rows.length === 0) {
            body.innerHTML = '<div style="color:var(--placeholder-color);">Aucun historique.</div>';
            return;
          }
          let html = '<table class="photo-history-table"><thead><tr><th>Horodatage</th><th>Action</th><th>Cat√©gorie</th><th>Nom</th><th>Photo</th></tr></thead><tbody>';
          rows.forEach(r => {
            const actionLabel = r.action === 'add' ? 'Ajout' : (r.action === 'modify' ? 'Modif' : 'Suppression');
            let imgHtml = '';
            if (r.base64) {
              const safe = r.base64.replace(/'/g, "\\'");
              imgHtml = `<img src="${r.base64}" class="photo-thumb" style="cursor:pointer;" onclick="showPhotoPreview('${safe}')" />`;
            }
            html += `<tr><td>${r.dateStr || ''}</td><td>${actionLabel}</td><td>${r.category || ''}</td><td><b>${r.bagName || ''}</b></td><td>${imgHtml}</td></tr>`;
          });
          html += '</tbody></table>';
          body.innerHTML = html;
        }).getPhotoHistory();
      }

      function enlargePhotoFromCheckModal() {
        const img = document.getElementById('locationPhoto');
        if (img && img.src) {
          showPhotoPreview(img.src);
        }
      }

      let pieChartInstance = null;
      let monthlyChartInstance = null;
      
      function renderStats() {
         const period = document.getElementById('stats-period')?.value || 'all';
         
         // Filtrer l'historique par p√©riode
         const now = new Date();
         let filteredHistory = D.history;
         if(period === 'month') {
           const monthAgo = new Date(now.getFullYear(), now.getMonth(), 1);
           filteredHistory = D.history.filter(h => {
             const hDate = h.date ? new Date(h.date) : null;
             return hDate && hDate >= monthAgo;
           });
         } else if(period === '3months') {
           const threeMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 3, 1);
           filteredHistory = D.history.filter(h => {
             const hDate = h.date ? new Date(h.date) : null;
             return hDate && hDate >= threeMonthsAgo;
           });
         } else if(period === 'year') {
           const yearAgo = new Date(now.getFullYear(), 0, 1);
           filteredHistory = D.history.filter(h => {
             const hDate = h.date ? new Date(h.date) : null;
             return hDate && hDate >= yearAgo;
           });
         }
         
         console.log("Filtered history count:", filteredHistory.length);
         console.log("Sample history item:", filteredHistory[0]);
         
         // 1. √âtat global (camembert)
         const okCount = D.inventory.filter(i => i.status === 'green' && i.state !== 'HS').length;
         const orangeCount = D.inventory.filter(i => i.status === 'orange' && i.state !== 'HS').length;
         const redCount = D.inventory.filter(i => i.status === 'red' && i.state !== 'HS').length;
         const purpleCount = D.inventory.filter(i => i.status === 'purple' && i.state !== 'HS').length;
         
         const pieCtx = document.getElementById('pieChart');
         if(pieChartInstance) pieChartInstance.destroy();
         pieChartInstance = new Chart(pieCtx, {
           type: 'pie',
           data: {
             labels: ['‚úì OK', '‚ö† Orange', '‚úó Retard', 'üü£ P√©rim√©'],
             datasets: [{
               data: [okCount, orangeCount, redCount, purpleCount],
               backgroundColor: ['#4caf50', '#ff9800', '#f44336', '#9c27b0']
             }]
           },
           options: {
             responsive: true,
             plugins: {
               legend: { position: 'bottom' }
             }
           }
         });
         
         // 2. Contr√¥les par mois
         const monthlyData = {};
         filteredHistory.forEach(h => {
           if(!h.date) return;
           const d = h.date instanceof Date ? h.date : new Date(h.date);
           if(isNaN(d.getTime())) return; // Skip invalid dates
           const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
           if(!monthlyData[key]) monthlyData[key] = 0;
           monthlyData[key]++;
         });
         
         const sortedMonths = Object.keys(monthlyData).sort();
         const monthlyCtx = document.getElementById('monthlyChart');
         if(monthlyChartInstance) monthlyChartInstance.destroy();
         monthlyChartInstance = new Chart(monthlyCtx, {
           type: 'bar',
           data: {
             labels: sortedMonths.map(m => m.replace('-', '/')),
             datasets: [{
               label: 'Contr√¥les effectu√©s',
               data: sortedMonths.map(m => monthlyData[m]),
               backgroundColor: '#1565c0'
             }]
           },
           options: {
             responsive: true,
             plugins: {
               legend: { display: true, labels: { padding: 15 } }
             },
             scales: {
               x: { 
                 display: true,
                 title: { display: true, text: 'Mois' }
               },
               y: { 
                 beginAtZero: true,
                 ticks: { stepSize: 1 },
                 title: { display: true, text: 'Nombre de contr√¥les' }
               }
             }
           }
         });
         
         // 3. Statistiques textuelles avanc√©es
         let html = '<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:15px; margin-top:20px;">';
         
         // D√©lais moyens PAR CAT√âGORIE
         const delaysByCategory = {};
         D.categoriesOrder.forEach(cat => {
           const delays = [];
           D.inventory.filter(item => item.category === cat).forEach(item => {
             const itemHist = filteredHistory.filter(h => h.name === item.name).sort((a,b) => {
               const dateA = a.date instanceof Date ? a.date : new Date(a.date);
               const dateB = b.date instanceof Date ? b.date : new Date(b.date);
               return dateA - dateB;
             });
             for(let i = 1; i < itemHist.length; i++) {
               const dateA = itemHist[i-1].date instanceof Date ? itemHist[i-1].date : new Date(itemHist[i-1].date);
               const dateB = itemHist[i].date instanceof Date ? itemHist[i].date : new Date(itemHist[i].date);
               if(!isNaN(dateA.getTime()) && !isNaN(dateB.getTime())) {
                 const diff = (dateB - dateA) / (1000 * 60 * 60 * 24);
                 if(diff > 0) delays.push(diff);
               }
             }
           });
           if(delays.length > 0) {
             delaysByCategory[cat] = (delays.reduce((a,b) => a+b, 0) / delays.length).toFixed(1);
           }
         });
         
         // Dur√©es de contr√¥le PAR CAT√âGORIE
         const durationsByCategory = {};
         D.categoriesOrder.forEach(cat => {
           const durationsInSeconds = [];
           D.inventory.filter(item => item.category === cat).forEach(item => {
             filteredHistory.filter(h => h.name === item.name).forEach(h => {
               const match = h.details.match(/\[‚è±Ô∏è\s*(\d+)min(\d+)s\]/);
               if(match) {
                 const totalSeconds = parseInt(match[1]) * 60 + parseInt(match[2]);
                 durationsInSeconds.push(totalSeconds);
               }
             });
           });
           if(durationsInSeconds.length > 0) {
             const avgSeconds = Math.round(durationsInSeconds.reduce((a,b) => a+b, 0) / durationsInSeconds.length);
             const minSeconds = Math.min(...durationsInSeconds);
             const maxSeconds = Math.max(...durationsInSeconds);
             
             const formatTime = (sec) => {
               const m = Math.floor(sec / 60);
               const s = sec % 60;
               return `${m}min${s}s`;
             };
             
             durationsByCategory[cat] = { 
               avg: formatTime(avgSeconds), 
               min: formatTime(minSeconds), 
               max: formatTime(maxSeconds) 
             };
           }
         });
         
         // Top 10 sacs en retard
         const lateData = D.inventory.map(item => ({
           name: item.name,
           lateCount: filteredHistory.filter(h => h.name === item.name && h.details && h.details.toLowerCase().includes('retard')).length
         })).filter(x => x.lateCount > 0).sort((a,b) => b.lateCount - a.lateCount).slice(0, 10);
         
         // Afficher d√©lais moyens par cat√©gorie
         html += `<div style="background:#e8f5e9; padding:15px; border-radius:8px; border-left:4px solid #4caf50; grid-column: 1 / -1;">
           <h4 style="margin:0 0 10px 0;">‚è±Ô∏è D√©lai Moyen Entre Contr√¥les (par cat√©gorie)</h4>`;
         if(Object.keys(delaysByCategory).length > 0) {
           Object.entries(delaysByCategory).forEach(([cat, avg]) => {
             html += `<div style="margin:8px 0; padding:8px; background:rgba(76,175,80,0.1); border-radius:4px;"><b>${cat}:</b> <span style="color:#4caf50; font-weight:bold; font-size:1.2em;">${avg} jours</span></div>`;
           });
         } else {
           html += `<div style="color:#999;">Pas assez de donn√©es</div>`;
         }
         html += `</div>`;
         
         // Afficher dur√©es par cat√©gorie
         html += `<div style="background:var(--section-bg); padding:15px; border-radius:8px; border-left:4px solid #ff9800; grid-column: 1 / -1; color:var(--text-color);">
           <h4 style="margin:0 0 10px 0;">‚è≥ Dur√©e Contr√¥les (par cat√©gorie)</h4>`;
         if(Object.keys(durationsByCategory).length > 0) {
           Object.entries(durationsByCategory).forEach(([cat, stats]) => {
             html += `<div style="margin:8px 0; padding:8px; background:rgba(255,152,0,0.1); border-radius:4px;"><b>${cat}:</b> <span style="color:#ff9800; font-weight:bold;">Moy: ${stats.avg}</span> <small>(${stats.min} - ${stats.max})</small></div>`;
           });
         } else {
           html += `<div style="color:#999;">Aucune donn√©e de chrono disponible</div>`;
         }
         html += `</div>`;
         
         html += `<div style="background:#e1f5fe; padding:15px; border-radius:8px; border-left:4px solid #1565c0;">
           <h4 style="margin:0 0 10px 0;">üìä Total Contr√¥les</h4>
           <div style="font-size:2rem; font-weight:bold; color:#1565c0;">${filteredHistory.length}</div>
           <small>Sur la p√©riode s√©lectionn√©e</small>
         </div>`;
         
         html += `<div style="background:#e8f5e9; padding:15px; border-radius:8px; border-left:4px solid #4caf50;">
           <h4 style="margin:0 0 10px 0;">‚úÖ % Dans les Temps</h4>
           <div style="font-size:2rem; font-weight:bold; color:#4caf50;">${((okCount / (okCount + orangeCount + redCount + purpleCount)) * 100).toFixed(0)}%</div>
           <small>Statut vert actuellement</small>
         </div>`;
         
         html += '</div>';
         
         // Liste compl√®te de tous les sacs avec retards/p√©rim√©s
         const allItemsData = D.inventory.map(item => {
           const lateCount = filteredHistory.filter(h => h.name === item.name && h.details && (h.details.toLowerCase().includes('retard') || h.details.toLowerCase().includes('p√©rim√©'))).length;
           return {
             name: item.name,
             category: item.category,
             state: item.state,
             lateCount: lateCount
           };
         }).sort((a,b) => b.lateCount - a.lateCount || a.name.localeCompare(b.name));
         
         html += '<div style="margin-top:30px; background:var(--card-bg); padding:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); color:var(--text-color);"><h4>üìã Liste Compl√®te - Sacs/VLI et Nombre de Retards/P√©rim√©s</h4><table class="inv-table"><thead><tr><th>Cat√©gorie</th><th>Nom</th><th style="text-align:center;">Retards/P√©rim√©s</th><th style="text-align:center;">√âtat</th></tr></thead><tbody>';
         allItemsData.forEach(item => {
           const colorClass = item.lateCount > 5 ? 'color:#f44336;' : (item.lateCount > 2 ? 'color:#ff9800;' : 'color:#4caf50;');
           const stateLabel = item.state === 'HS' ? '<span style="background:#f44336; color:white; padding:2px 6px; border-radius:3px; font-size:0.8em;">HS</span>' : '';
           html += `<tr><td>${item.category}</td><td><b>${item.name}</b></td><td style="text-align:center; ${colorClass} font-weight:bold;">${item.lateCount}</td><td style="text-align:center;">${stateLabel}</td></tr>`;
         });
         html += '</tbody></table></div>';
         
         // Top 10 retards (optionnel, on peut le garder ou le supprimer)
         /*
         if(lateData.length > 0) {
           html += '<div style="margin-top:30px; background:var(--card-bg); padding:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); color:var(--text-color);"><h4>üî¥ Top 10 - Sacs Souvent en Retard</h4><table class="inv-table"><thead><tr><th>Sac</th><th style="text-align:center;">Retards</th></tr></thead><tbody>';
           lateData.forEach(item => {
             html += `<tr><td><b>${item.name}</b></td><td style="text-align:center; color:#f44336; font-weight:bold;">${item.lateCount}</td></tr>`;
           });
           html += '</tbody></table></div>';
         }
         */
         
         document.getElementById('stats-text-container').innerHTML = html;
      }

      function setMailTemplate(type) {
        if(type === 'orange') {
          document.getElementById('mailOrangeSub2').value = "‚ö†Ô∏è Revalidation requise pour {nom}";
          document.getElementById('mailOrangeBody2').value = "Bonjour,\n\nLe sac/VLI {nom} ({categorie}) arrive en fin de validit√© le {date}.\n\nUne revalidation est n√©cessaire d√®s que possible pour maintenir la conformit√©.\n\nMerci de proc√©der au contr√¥le rapidement.";
        } else if(type === 'red') {
          document.getElementById('mailRedSub2').value = "üî¥ URGENT - Validit√© d√©pass√©e pour {nom}";
          document.getElementById('mailRedBody2').value = "URGENT!\n\nLe sac/VLI {nom} ({categorie}) a d√©pass√© sa date de validit√© depuis le {date}.\n\nCe mat√©riel N'EST PLUS CONFORME et ne peut pas √™tre utilis√©.\n\nUne revalidation imm√©diate et obligatoire est requise!\n\nMerci d'agir sans d√©lai.";
        }
      }

      function renderEditor() {
         const cat = document.getElementById('cat-selector').value; 
         const c = document.getElementById('editor-container'); 
         if(!c) return; 
         c.innerHTML='';
         
         if(!D.forms || !D.forms[cat]) {
             c.innerHTML = '<div style="background:var(--section-bg); padding:15px; border-radius:4px; color:#c62828; border:1px solid #c62828;"><b>‚ö†Ô∏è Aucun formulaire</b> pour cette cat√©gorie. Commencez par ajouter une section.</div>';
             return;
         }
         
         const nbSections = D.forms[cat].length;
         D.forms[cat].forEach((sec, secIdx) => {
             let h = `<div class="section-block" data-section-idx="${secIdx}"><div class="section-header"><span style="cursor:move; padding:5px; color:var(--text-color);">‚ò∞</span><input class="sec-name" value="${sec.section}" placeholder="Section" style="flex:1;"><input class="sec-pos" value="${sec.position || ''}" placeholder="Position" style="width:120px;"><button class="admin-btn danger" style="padding:5px 10px;" onclick="deleteSectionConfirm(${secIdx})">‚úï</button></div><div class="items-list">`;
             if(sec.items && sec.items.length > 0) {
                 const nbItems = sec.items.length;
                 sec.items.forEach((i, itemIdx) => {
                    h += `<div class="item-row" data-item-idx="${itemIdx}"><span style="cursor:move; color:#999;">‚ãÆ‚ãÆ</span><input class="i-name" value="${i.name}" placeholder="Nom item" style="flex:1;"><select class="i-type"><option value="texte" ${i.type=='texte'?'selected':''}>Texte</option><option value="case" ${i.type=='case'?'selected':''}>Case</option><option value="nombre" ${i.type=='nombre'?'selected':''}>Nombre</option><option value="date" ${i.type=='date'?'selected':''}>Date</option></select><input class="i-def" value="${i.def||''}" placeholder="D√©faut" style="width:80px;"><button class="admin-btn danger" style="padding:5px 8px;" onclick="deleteItemConfirm(this)">‚úï</button><button class="admin-btn secondary" style="padding:5px 8px;" onclick="quickSaveEditor()">üíæ</button></div>`;
                 });
             }
             h += `</div><div style="padding:10px; background:var(--section-bg);"><button class="admin-btn secondary" onclick="addItem(this)">+ Item</button></div></div>`;
             c.innerHTML += h;
         });
         
         // Initialiser Sortable pour les sections
         new Sortable(c, {
           animation: 150,
           handle: '.section-header span',
           onEnd: function() { quickSaveEditor(); }
         });
         
         // Initialiser Sortable pour chaque liste d'items
         document.querySelectorAll('.items-list').forEach(list => {
           new Sortable(list, {
             animation: 150,
             handle: '.item-row span',
             onEnd: function() { quickSaveEditor(); }
           });
         });
      }
      
      function moveSectionUp(idx) {
        const cat = document.getElementById('cat-selector').value;
        if(idx === 0) return;
        const temp = D.forms[cat][idx];
        D.forms[cat][idx] = D.forms[cat][idx-1];
        D.forms[cat][idx-1] = temp;
        renderEditor();
        quickSaveEditor();
      }
      
      function moveSectionDown(idx) {
        const cat = document.getElementById('cat-selector').value;
        if(idx >= D.forms[cat].length - 1) return;
        const temp = D.forms[cat][idx];
        D.forms[cat][idx] = D.forms[cat][idx+1];
        D.forms[cat][idx+1] = temp;
        renderEditor();
        quickSaveEditor();
      }
      
      function moveItemUp(secIdx, itemIdx) {
        const cat = document.getElementById('cat-selector').value;
        if(itemIdx === 0) return;
        const items = D.forms[cat][secIdx].items;
        const temp = items[itemIdx];
        items[itemIdx] = items[itemIdx-1];
        items[itemIdx-1] = temp;
        renderEditor();
        quickSaveEditor();
      }
      
      function moveItemDown(secIdx, itemIdx) {
        const cat = document.getElementById('cat-selector').value;
        const items = D.forms[cat][secIdx].items;
        if(itemIdx >= items.length - 1) return;
        const temp = items[itemIdx];
        items[itemIdx] = items[itemIdx+1];
        items[itemIdx+1] = temp;
        renderEditor();
        quickSaveEditor();
      }
      
      function deleteSectionConfirm(idx) {
        if(confirm("Supprimer cette section et tous ses items ?")) {
          const blocks = document.querySelectorAll('.section-block');
          blocks[idx].remove();
          quickSaveEditor();
        }
      }
      
      function deleteItemConfirm(btn) {
        if(confirm("Supprimer cet item ?")) {
          btn.closest('.item-row').remove();
          quickSaveEditor();
        }
      }
      
      function quickSaveEditor() { saveEditor(); }

      function saveEditor() {
         const cat = document.getElementById('cat-selector').value; let data = [];
         document.querySelectorAll('.section-block').forEach(blk => {
            let s = blk.querySelector('.sec-name').value; let p = blk.querySelector('.sec-pos').value;
            blk.querySelectorAll('.item-row').forEach(row => {
               data.push({ section: s, position: p, item: row.querySelector('input').value, type: row.querySelector('select').value, def: row.querySelectorAll('input')[1].value });
            });
         });
         google.script.run.withSuccessHandler(loadData).updateCategoryContent(cat, data);
      }
      
      function addItem(b) { b.parentElement.previousElementSibling.innerHTML += `<div class="item-row"><span style="cursor:move; color:#999;">‚ãÆ‚ãÆ</span><input placeholder="Item" style="flex:1;"><select><option value="texte">Texte</option><option value="case">Case</option><option value="nombre">Nombre</option><option value="date">Date</option></select><input placeholder="D√©faut" style="width:80px;"><button class="admin-btn danger" style="padding:5px 8px;" onclick="this.parentElement.remove()">‚úï</button><button class="admin-btn secondary" style="padding:5px 8px;" onclick="quickSaveEditor()">üíæ</button></div>`; }
      function addSection() { document.getElementById('editor-container').innerHTML += `<div class="section-block"><div class="section-header"><span style="cursor:move; padding:5px; color:var(--text-color);">‚ò∞</span><input value="Nouvelle Section" style="flex:1;"><input placeholder="Pos" style="width:120px;"></div><div class="items-list"></div><div style="padding:10px; background:var(--section-bg);"><button class="admin-btn secondary" onclick="addItem(this)">+ Item</button></div></div>`; }
      function showQR(n) { const u = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(APP_URL + "?bag=" + n)}`; document.getElementById('qrTitle').innerText = n; document.getElementById('qr-img').src = u; document.getElementById('qrModal').style.display = 'flex'; }
      function downloadQR() { window.open(document.getElementById('qr-img').src); }
      function printQR() { let w = window.open(''); w.document.write(`<img src="${document.getElementById('qr-img').src}" onload="window.print()">`); }
      function openHistoryDetail(idx) { 
        const h = D.history[idx]; 
        // Extraire et supprimer le temps de v√©rification du champ details
        let timeDisplay = "";
        let detailsClean = h.details;
        const timeMatch = detailsClean.match(/\s*\[‚è±Ô∏è\s*(\d+)min(\d+)s\]/);
        if(timeMatch) {
          timeDisplay = `<div style="background:#fff3cd; padding:10px; border-radius:4px; margin-bottom:15px; border-left:4px solid #ffc107;"><b>‚è±Ô∏è Temps de v√©rification:</b> <span style="font-size:1.1em; color:#ff9800;">${timeMatch[1]} min ${timeMatch[2]} s</span></div>`;
          detailsClean = detailsClean.replace(timeMatch[0], ''); // Supprimer le temps pour le parsing
        }
        let html = `<h3>${h.name}</h3><p>V√©rifi√© par ${h.verifier} le ${h.dateStr}</p>${timeDisplay}<hr>`;
        if(detailsClean.startsWith("{")){
          try{ let j = JSON.parse(detailsClean.split(" || ")[0]); for(let k in j) html += `<b>${k}:</b> ${j[k]}<br>`; }catch(e){}
        } else { html += detailsClean; }
        document.getElementById('hist-detail').innerHTML = html;
        document.getElementById('histModal').style.display = 'flex';
      }
      function closeM(id) { document.getElementById(id).style.display = 'none'; }
      
      function renameBag(oldName) {
        const newName = prompt(`Renommer "${oldName}" en:`, oldName);
        if(!newName || newName === oldName) return;
        google.script.run.withSuccessHandler(() => {
          loadData();
        }).withFailureHandler(err => alert('Erreur: ' + err)).renameBag(oldName, newName);
      }

      function renameCategory(oldCat) {
        const newCat = prompt(`Renommer la cat√©gorie "${oldCat}" en:`, oldCat);
        if(!newCat || newCat === oldCat) return;
        google.script.run.withSuccessHandler(() => {
          loadData();
        }).withFailureHandler(err => alert('Erreur: ' + err)).renameCategory(oldCat, newCat);
      }
      
      function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
      function toggleAdmin() { if(!IS_ADM && prompt("Mdp ?")!=="66000") return; IS_ADM=true; document.getElementById('dashboard-view').style.display = 'none'; document.getElementById('admin-view').style.display = 'block'; }
      function backToDashboard() { document.getElementById('admin-view').style.display = 'none'; document.getElementById('dashboard-view').style.display = 'block'; }
      function showTab(id) { 
        document.querySelectorAll('.admin-tab').forEach(e=>e.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
        // Mettre √† jour les boutons de navigation
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        event?.target?.classList.add('active');
        if(id === 'tab-stats') renderStats(); 
      }
      function saveOptions() { google.script.run.withSuccessHandler(loadData).saveGlobalOptions({ enableExpiry: document.getElementById('opt-exp').checked, enableQR: document.getElementById('opt-qr').checked, enableVerifier: document.getElementById('opt-verif').checked, enablePhotos: document.getElementById('opt-photo').checked }); }
      function saveMailConfDirect() { google.script.run.withSuccessHandler(() => alert("Sauv√©")).saveMailConfig({ orangeSub: document.getElementById('mailOrangeSub2').value, orangeBody: document.getElementById('mailOrangeBody2').value, redSub: document.getElementById('mailRedSub2').value, redBody: document.getElementById('mailRedBody2').value }); }
      function installTriggerUI() { google.script.run.withSuccessHandler(alert).installTrigger(document.getElementById('trigger-hour').value); }
      function updateMail(i) { google.script.run.updateBagMails(i.dataset.bag, i.dataset.type, i.value); }
      function saveAllVliLocations() {
        const list = [];
        document.querySelectorAll('#vli-loc-body input[data-bag]').forEach(i => {
          list.push({ name: i.dataset.bag, location: i.value });
        });
        google.script.run.withSuccessHandler(loadData).updateVliLocationsBatch(list);
      }
      function setSortMode(mode) {
        SORT_MODE = mode;
        localStorage.setItem('sortMode', mode);
        render();
      }

      let INV_SORTABLE = null;
      let CAT_SORTABLE = null;
      function initInventorySortable() {
        const el = document.getElementById('inv-body');
        if (!el || INV_SORTABLE) return;
        INV_SORTABLE = new Sortable(el, {
          animation: 150,
          handle: '.inv-drag',
          onEnd: updateInventoryOrderFromDOM
        });
      }
      function updateInventoryOrderFromDOM() {
        const rows = Array.from(document.querySelectorAll('#inv-body tr'));
        const counters = {};
        const list = [];
        rows.forEach(r => {
          const cat = r.dataset.cat;
          if (!counters[cat]) counters[cat] = 1;
          const order = counters[cat]++;
          const cell = r.querySelector('.order-cell');
          if (cell) cell.textContent = order;
          list.push({ name: r.dataset.bag, order: order });
        });
        google.script.run.withSuccessHandler(loadData).updateBagOrders(list);
      }
      function initCategorySortable() {
        const el = document.getElementById('cat-conf');
        if (!el || CAT_SORTABLE) return;
        CAT_SORTABLE = new Sortable(el, {
          animation: 150,
          handle: '.drag-handle',
          onEnd: saveCatConf
        });
      }
      function addBag() { google.script.run.withSuccessHandler(loadData).addBag(document.getElementById('new-bag-cat').value, document.getElementById('new-bag-name').value); }
      function delBag(n) { if(confirm('Supprimer ?')) google.script.run.withSuccessHandler(loadData).deleteBag(n); }
      function setBagStatus(n,s) { google.script.run.withSuccessHandler(loadData).updateBagStatus(n,s); }
      function addCat() { google.script.run.withSuccessHandler(loadData).createNewCategory(document.getElementById('new-cat-name').value); }
      function deleteCategoryConfirm(catName) {
        if(confirm(`‚ö†Ô∏è ATTENTION !\n\nSupprimer la cat√©gorie "${catName}" ?\n\nCela supprimera √©galement :\n- Tous les sacs/VLI de cette cat√©gorie\n- Toutes les checklists associ√©es\n- L'historique de cette cat√©gorie\n\nCette action est IRR√âVERSIBLE !`)) {
          google.script.run.withSuccessHandler(loadData).deleteCategory(catName);
        }
      }
      function deleteHistoryConfirm(idx, bagName, dateStr) {
        if(confirm(`Supprimer la v√©rification de "${bagName}" du ${dateStr} ?\n\nCette action est irr√©versible.`)) {
          google.script.run.withSuccessHandler(loadData).deleteHistoryEntry(idx);
        }
      }
      function saveCatConf() { let c = []; document.querySelectorAll('.cat-row').forEach(r => c.push({ name: r.querySelector('.cat-name-input').value, freq: r.querySelector('.cat-freq-input').value })); google.script.run.withSuccessHandler(loadData).updateCategoriesConfig(c); }
      function forceReload() { location.reload(); }
      
      function generatePdfForItem(itemName) {
        const hist = D.history.filter(h => h.name === itemName);
        if(hist.length === 0) { alert("Aucun historique pour cet item"); return; }
        
        let html = `<html><head><meta charset="utf-8"><title>${itemName}</title><style>
          body { font-family: Arial; margin: 20px; }
          h1 { color: #1565c0; border-bottom: 3px solid #1565c0; padding-bottom: 10px; }
          .entry { page-break-inside: avoid; margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 6px; }
          .date { font-weight: bold; color: #1565c0; }
          .verifier { color: #666; font-size: 0.9rem; }
          table { width: 100%; border-collapse: collapse; margin-top: 10px; }
          td { padding: 8px; border-bottom: 1px solid #eee; }
          td:first-child { font-weight: bold; width: 30%; }
        </style></head><body>
        <h1>Historique: ${itemName}</h1>
        <p>Total: ${hist.length} contr√¥le(s)</p>`;
        
        hist.forEach(h => {
          html += `<div class="entry"><div class="date">üìÖ ${h.dateStr}</div><div class="verifier">üë§ ${h.verifier || 'N/A'}</div>`;
          if(h.details.startsWith("{")) {
            try{ let j = JSON.parse(h.details.split(" || ")[0]); 
              html += `<table>`;
              for(let k in j) html += `<tr><td>${k}</td><td>${j[k]}</td></tr>`;
              html += `</table>`;
            }catch(e){}
          } else { html += `<p>${h.details}</p>`; }
          html += `</div>`;
        });
        
        html += `</body></html>`;
        const w = window.open('', '', 'width=800,height=600');
        w.document.write(html);
        w.document.close();
        setTimeout(() => w.print(), 500);
      }

      // === MOBILE MODE ===
      function chooseMobile() { localStorage.setItem('checklistMode','mobile'); document.body.classList.add('mobile-mode'); document.getElementById('splashChoice').style.display='none'; showModeStrip('mobile'); }
      function chooseDesktop() { localStorage.setItem('checklistMode','desktop'); document.body.classList.remove('mobile-mode'); document.getElementById('splashChoice').style.display='none'; showModeStrip('desktop'); }
      function switchMode(m) { if(m==='mobile') chooseMobile(); else chooseDesktop(); }
      function showModeStrip(m) { 
        var s = document.getElementById('modeStrip'); s.style.display='block'; 
        s.innerHTML = m==='mobile' ? 'üì± Mobile <a onclick="switchMode(\'desktop\')">Passer en PC</a>' : 'üíª PC <a onclick="switchMode(\'mobile\')">Passer en mobile</a>'; 
      }
      (function(){ var s=localStorage.getItem('checklistMode'); if(s==='mobile'||s==='desktop'){document.getElementById('splashChoice').style.display='none';showModeStrip(s);if(s==='mobile')document.body.classList.add('mobile-mode');} })();

      // === VLI IMPACT ===
      let CURR_VLI_NAME = '';
      
      function openVliImpact(name) {
        CURR_VLI_NAME = name;
        document.getElementById('vliImpactTitle').textContent = 'üîç Impact ‚Äî ' + name;
        document.getElementById('vliImpactBody').innerHTML = '<div class="mini-spinner"></div> Chargement...';
        document.getElementById('vliImpactModal').style.display = 'flex';
        google.script.run.withSuccessHandler(renderVliImpacts).getVliImpacts(name);
      }
      
      function renderVliImpacts(impacts) {
        const body = document.getElementById('vliImpactBody');
        if(!impacts || impacts.length === 0) { 
          body.innerHTML = '<div style="text-align:center;color:#999;padding:30px;">Aucune photo d\'impact pour ce v√©hicule.<br><br>Utilisez le bouton ci-dessous pour ajouter des photos de rayures, bosses ou dommages.</div>'; 
          return; 
        }
        let html = '';
        impacts.forEach(imp => {
          html += `<div style="border:1px solid var(--border-color); border-radius:8px; margin-bottom:12px; overflow:hidden; background:var(--section-bg);">
            <img src="${imp.base64}" style="width:100%; max-height:300px; object-fit:contain; background:#000; cursor:pointer;" onclick="showPhotoPreview(this.src)">
            <div style="padding:10px;">
              <div style="font-size:0.85rem; color:#999;">üìÖ ${imp.dateStr}</div>
              <div style="margin-top:6px; color:var(--text-color);">${imp.comment || '<i style="color:#999">Aucun commentaire</i>'}</div>
              <div style="margin-top:8px; display:flex; gap:6px;">
                <button class="admin-btn secondary" style="padding:4px 8px; font-size:0.8rem;" onclick="editImpactComment('${imp.fileId}')">‚úèÔ∏è Modifier</button>
                <button class="admin-btn" style="padding:4px 8px; font-size:0.8rem; background:#d32f2f;" onclick="deleteImpact('${imp.fileId}')">üóëÔ∏è Supprimer</button>
              </div>
            </div>
          </div>`;
        });
        body.innerHTML = html;
      }
      
      function addVliImpactPhoto() {
        document.getElementById('impactInput').click();
      }
      
      function handleImpactUpload(input) {
        if(!input.files || !input.files[0]) return;
        const comment = prompt('Commentaire pour cette photo (optionnel):', '') || '';
        const r = new FileReader(); 
        r.onload = e => {
          const img = new Image(); img.src = e.target.result;
          img.onload = () => {
            const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
            const MAX = 800; let w = img.width, h = img.height;
            if(w > MAX) { h *= MAX/w; w = MAX; }
            canvas.width = w; canvas.height = h; ctx.drawImage(img, 0, 0, w, h);
            document.getElementById('vliImpactBody').innerHTML = '<div class="mini-spinner"></div> Envoi en cours...';
            google.script.run.withSuccessHandler(res => {
              if(res && res.success) openVliImpact(CURR_VLI_NAME);
              else alert('Erreur: ' + (res ? res.error : '?'));
            }).saveVliImpact(CURR_VLI_NAME, canvas.toDataURL('image/jpeg', 0.7), comment);
          };
        }; 
        r.readAsDataURL(input.files[0]);
        input.value = '';
      }
      
      function deleteImpact(fileId) {
        if(!confirm('Supprimer cette photo d\'impact ?')) return;
        document.getElementById('vliImpactBody').innerHTML = '<div class="mini-spinner"></div> Suppression...';
        google.script.run.withSuccessHandler(res => {
          if(res && res.success) openVliImpact(CURR_VLI_NAME);
          else alert('Erreur de suppression');
        }).deleteVliImpact(fileId);
      }
      
      function editImpactComment(fileId) {
        const c = prompt('Nouveau commentaire:', '');
        if(c === null) return;
        google.script.run.withSuccessHandler(res => {
          if(res && res.success) openVliImpact(CURR_VLI_NAME);
        }).updateVliImpactComment(fileId, c);
      }
    </script>
  </body>
</html>
